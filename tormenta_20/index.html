<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grim√≥rio de Fichas T20</title>
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <style>
        body {
            font-family: sans-serif; background-color: #1a1a1a; color: #e0e0e0;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            height: 100vh; margin: 0;
        }
        .container { text-align: center; padding: 20px; background: #2d2d2d; border-radius: 10px; }
        .loader { font-size: 1.5rem; margin-bottom: 15px; color: #ff4d4d; }
        .status { font-size: 0.9rem; color: #aaa; }
        button {
            padding: 10px 25px; margin-top: 20px; font-size: 1rem; cursor: pointer;
            background-color: #ff4d4d; color: white; border: none; border-radius: 5px;
            display: none; /* S√≥ aparece se der erro */
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="loader" id="msg">üßô‚Äç‚ôÇÔ∏è Invocando a ficha...</div>
        <div class="status" id="log">Lendo pergaminhos...</div>
        <button id="retryBtn" onclick="location.reload()">Tentar Novamente</button>
    </div>

    <script>
        const { PDFDocument, PDFTextField, PDFCheckBox, PDFDropdown } = PDFLib;

        // MAPA DE CAMPOS (Removi PV e PM propositalmente para seguran√ßa extra)
        const fieldMap = {
            'nome': 'NOME DO PERSONAGEM',
            'jogador': 'JOGADOR',
            'raca': 'RA√áA',
            'origem': 'ORIGEM',
            'classe': 'CLASSE',
            'nivel': 'Lv',
            'divindade': 'DIVINDADE',
            'historia': 'Descri√ß√£o',
            'hab_raca': 'HabRa√ßasOrigem',
            'hab_classe': 'HabClassePoderes',
            'magias': 'Magias',
            'notas': 'Anota√ß√µes',
            'atrib_magia': 'SeleAtribMagia',
            'mod_magia': 'ModAtribMagia',
            'cd_magia': 'TesteResist',
            'dinheiro': '110',
            'carga_atual': 'CargaTotal',
            'carga_max': 'CargaMax',
            'obs_carga': 'Observa√ß√£o',
            'for': 'For', 'mod_for': 'ModFor',
            'des': 'Des', 'mod_des': 'ModDes',
            'con': 'Con', 'mod_con': 'ModCon',
            'int': 'Int', 'mod_int': 'ModInt',
            'sab': 'Sab', 'mod_sab': 'ModSab',
            'car': 'Car', 'mod_car': 'ModCar',
            // 'pv_max': 'PVs Totais',  <-- COMENTADOS POR SEGURAN√áA
            // 'pm_max': 'PMs Totais', 
            'defesa': 'CA',
            'item1': 'Item1', 'peso1': 'PesoItem1',
            'item2': 'Item2', 'peso2': 'PesoItem2',
            'treino_luta': 'Mar Trei luta', 'total_luta': '190',
            'treino_pont': 'Mar Trei ponta', 'total_pont': '260'
            // ... Adicione os outros treinos se precisar ...
        };

        async function preencherFicha() {
            try {
                const params = new URLSearchParams(window.location.search);
                const urlPdf = './Ficha T20 v.2.0.pdf';

                const existingPdfBytes = await fetch(urlPdf).then(res => {
                    if (!res.ok) throw new Error("N√£o achei o arquivo PDF na pasta raiz!");
                    return res.arrayBuffer();
                });

                const pdfDoc = await PDFDocument.load(existingPdfBytes);
                const form = pdfDoc.getForm();
                let camposPreenchidos = 0;

                for (const [urlParam, pdfFieldName] of Object.entries(fieldMap)) {
                    const valor = params.get(urlParam);
                    if (valor) {
                        // BLOCO DE SEGURAN√áA M√ÅXIMA
                        // Se um campo der erro, ele ignora e vai pro pr√≥ximo
                        try {
                            const field = form.getField(pdfFieldName);
                            
                            if (field instanceof PDFTextField) {
                                field.setText(valor);
                            } else if (field instanceof PDFCheckBox) {
                                if (['true', '1', 'sim', 'x'].includes(valor.toLowerCase())) field.check();
                            } else if (field instanceof PDFDropdown) {
                                field.select(valor);
                            }
                            camposPreenchidos++;
                        } catch (fieldError) {
                            console.warn(`Pulei o campo com erro: ${pdfFieldName}`, fieldError);
                            // N√£o faz nada, apenas segue a vida!
                        }
                    }
                }

                const pdfBytes = await pdfDoc.save();
                const blob = new Blob([pdfBytes], { type: 'application/pdf' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                const nomeArquivo = params.get('nome') || 'Aventureiro';
                link.download = `Ficha_${nomeArquivo}.pdf`;
                link.click();
                
                document.getElementById('msg').innerHTML = `‚úÖ Ficha Baixada!`;
                document.getElementById('log').innerHTML = "Sucesso!";
                document.getElementById('log').style.color = "#4caf50";

            } catch (err) {
                console.error(err);
                document.getElementById('msg').innerHTML = "‚ùå Erro Geral";
                document.getElementById('log').innerText = err.message;
                document.getElementById('retryBtn').style.display = "inline-block";
            }
        }
        preencherFicha();
    </script>
</body>
</html>