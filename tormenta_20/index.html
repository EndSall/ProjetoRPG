<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grim√≥rio de Fichas T20</title>
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #1a1a1a; color: #e0e0e0;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            height: 100vh; margin: 0;
        }
        .container { text-align: center; padding: 20px; background: #2d2d2d; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.5); }
        .loader { font-size: 1.5rem; margin-bottom: 15px; color: #ff4d4d; }
        .status { font-size: 0.9rem; color: #aaa; margin-bottom: 20px; }
        button {
            padding: 10px 25px; font-size: 1rem; cursor: pointer;
            background-color: #ff4d4d; color: white; border: none; border-radius: 5px;
            display: none; transition: background 0.3s;
        }
        button:hover { background-color: #e60000; }
        a { color: #ff4d4d; text-decoration: none; font-weight: bold; }
    </style>
</head>
<body>
    <div class="container">
        <div class="loader" id="msg">üßô‚Äç‚ôÇÔ∏è Invocando a ficha...</div>
        <div class="status" id="log">Lendo pergaminhos...</div>
        <button id="retryBtn" onclick="location.reload()">Tentar Novamente</button>
    </div>

    <script>
        const { PDFDocument, PDFTextField, PDFCheckBox, PDFDropdown } = PDFLib;

        // --- MAPA MESTRE DE CAMPOS (URL -> PDF) ---
        // Baseado nos seus logs e prints
        const fieldMap = {
            // Cabe√ßalho
            'nome': 'NOME DO PERSONAGEM',
            'jogador': 'JOGADOR',
            'raca': 'RA√áA',
            'origem': 'ORIGEM',
            'classe': 'CLASSE',
            'nivel': 'Lv',
            'divindade': 'DIVINDADE',

            // Textos Longos (Separados)
            'historia': 'Descri√ß√£o',
            'hab_raca': 'HabRa√ßasOrigem',
            'hab_classe': 'HabClassePoderes',
            'magias': 'Magias',     // Caixa de texto das magias
            'notas': 'Anota√ß√µes',

            // Cabe√ßalho de Magia (T√©cnico)
            'atrib_magia': 'SeleAtribMagia', // Dropdown (Int/Sab/Car)
            'mod_magia': 'ModAtribMagia',    // N√∫mero
            'cd_magia': 'TesteResist',       // N√∫mero (CD)

            // Dinheiro e Carga
            'dinheiro': '110',      // Campo mapeado como 110
            'carga_atual': 'CargaTotal',
            'carga_max': 'CargaMax',
            'obs_carga': 'Observa√ß√£o',

            // Atributos
            'for': 'For', 'mod_for': 'ModFor',
            'des': 'Des', 'mod_des': 'ModDes',
            'con': 'Con', 'mod_con': 'ModCon',
            'int': 'Int', 'mod_int': 'ModInt',
            'sab': 'Sab', 'mod_sab': 'ModSab',
            'car': 'Car', 'mod_car': 'ModCar',

            // Status Vitals
            'pv_max': 'PVs Totais', 'pv_atual': 'PVs Atuais',
            'pm_max': 'PMs Totais', 'pm_atual': 'PMs Atuais',
            'defesa': 'CA',

            // Itens (At√© 10 slots)
            'item1': 'Item1', 'peso1': 'PesoItem1',
            'item2': 'Item2', 'peso2': 'PesoItem2',
            'item3': 'Item3', 'peso3': 'PesoItem3',
            'item4': 'Item4', 'peso4': 'PesoItem4',
            'item5': 'Item5', 'peso5': 'PesoItem5',
            'item6': 'Item6', 'peso6': 'PesoItem6',
            'item7': 'Item7', 'peso7': 'PesoItem7',
            'item8': 'Item8', 'peso8': 'PesoItem8',
            'item9': 'Item9', 'peso9': 'PesoItem9',
            'item10': 'Item10', 'peso10': 'PesoItem10',

            // Per√≠cias (Checkbox + Total)
            // L√≥gica: URL envia 'true' para marcar o X
            'treino_acro': 'Mar Trei acro', 'total_acro': '010',
            'treino_ades': 'Mar Trei ades', 'total_ades': '020',
            'treino_atle': 'Mar Trei atle', 'total_atle': '030',
            'treino_atua': 'Mar Trei atua', 'total_atua': '040',
            'treino_cava': 'Mar Trei caval', 'total_cava': '050',
            'treino_conh': 'Mar Trei conhe', 'total_conh': '060',
            'treino_cura': 'Mar Trei cura', 'total_cura': '070',
            'treino_dipl': 'Mar Trei dipl', 'total_dipl': '080',
            'treino_enga': 'Mar Trei enga', 'total_enga': '090',
            'treino_fort': 'Mar Trei forti', 'total_fort': '100',
            'treino_furt': 'Mar Trei furti', 'total_furt': '111',
            'treino_guer': 'Mar Trei guerra', 'total_guer': '120',
            'treino_inic': 'Mar Trei ini', 'total_inic': '130',
            'treino_inti': 'Mar Trei inti', 'total_inti': '140',
            'treino_intu': 'Mar Trei intu', 'total_intu': '150',
            'treino_inve': 'Mar Trei inve', 'total_inve': '160',
            'treino_joga': 'Mar Trei joga', 'total_joga': '170',
            'treino_ladi': 'Mar Trei ladi', 'total_ladi': '180',
            'treino_luta': 'Mar Trei luta', 'total_luta': '190',
            'treino_mist': 'Mar Trei misti', 'total_mist': '200',
            'treino_nobr': 'Mar Trei nobre', 'total_nobr': '220',
            'treino_perc': 'Mar Trei perce', 'total_perc': '250',
            'treino_pilo': 'Mar Trei pilo', 'total_pilo': '210', // Ordem num√©rica estranha no PDF, mantido conforme log
            'treino_pont': 'Mar Trei ponta', 'total_pont': '260',
            'treino_refl': 'Mar Trei refle', 'total_refl': '270',
            'treino_reli': 'Mar Trei reli', 'total_reli': '280',
            'treino_sobr': 'Mar Trei sobre', 'total_sobr': '290',
            'treino_vont': 'Mar Trei vonta', 'total_vont': '301'
        };

        async function preencherFicha() {
            try {
                // 1. Captura par√¢metros da URL
                const params = new URLSearchParams(window.location.search);
                const urlPdf = './Ficha T20 v.2.0.pdf'; // O PDF DEVE ESTAR AQUI

                // 2. Carrega o PDF Original
                const existingPdfBytes = await fetch(urlPdf).then(res => {
                    if (!res.ok) throw new Error("PDF n√£o encontrado na pasta.");
                    return res.arrayBuffer();
                });

                const pdfDoc = await PDFDocument.load(existingPdfBytes);
                const form = pdfDoc.getForm();
                let camposPreenchidos = 0;

                // 3. Loop de Preenchimento Inteligente
                for (const [urlParam, pdfFieldName] of Object.entries(fieldMap)) {
                    const valor = params.get(urlParam);
                    
                    if (valor) {
                        try {
                            const field = form.getField(pdfFieldName);
                            
                            // L√≥gica para Texto
                            if (field instanceof PDFTextField) {
                                field.setText(valor);
                                camposPreenchidos++;
                            } 
                            // L√≥gica para Checkbox (Treino)
                            else if (field instanceof PDFCheckBox) {
                                if (['true', '1', 'sim', 'x'].includes(valor.toLowerCase())) {
                                    field.check();
                                    camposPreenchidos++;
                                }
                            }
                            // L√≥gica para Dropdown (Atributo M√°gico)
                            else if (field instanceof PDFDropdown) {
                                // Tenta selecionar. Se falhar, avisa no console mas n√£o quebra.
                                const options = field.getOptions();
                                if (options.includes(valor)) {
                                    field.select(valor);
                                    camposPreenchidos++;
                                } else {
                                    console.warn(`Op√ß√£o '${valor}' inv√°lida para dropdown ${pdfFieldName}. Op√ß√µes: ${options}`);
                                }
                            }

                        } catch (e) {
                            console.warn(`Campo '${pdfFieldName}' (Param: ${urlParam}) ignorado: ${e.message}`);
                        }
                    }
                }

                // 4. Salva e Gera Download
                const pdfBytes = await pdfDoc.save();
                const blob = new Blob([pdfBytes], { type: 'application/pdf' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                const nomeArquivo = params.get('nome') || 'Aventureiro';
                link.download = `Ficha_${nomeArquivo}.pdf`;
                link.click();
                
                // 5. Feedback Visual
                document.getElementById('msg').innerHTML = `‚úÖ Ficha de <b>${nomeArquivo}</b> gerada!`;
                document.getElementById('log').innerHTML = `${camposPreenchidos} campos preenchidos. Verifique seus downloads.`;
                document.getElementById('log').style.color = "#4caf50";

            } catch (err) {
                console.error(err);
                document.getElementById('msg').innerHTML = "‚ùå Falha cr√≠tica!";
                document.getElementById('log').innerText = err.message;
                document.getElementById('retryBtn').style.display = "inline-block";
            }
        }

        // Inicia automaticamente ao abrir a p√°gina
        preencherFicha();
    </script>
</body>
</html>